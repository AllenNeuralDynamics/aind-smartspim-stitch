#!/usr/bin/env bash
set -ex

# This is the master script for the capsule. When you click "Reproducible Run", the code in this file will execute.

# Activate stitch env to solve argschema python version bug
source /opt/conda/etc/profile.d/conda.sh
conda activate smart_stitcher

# Split parameters for argschema
# provide preprocessed_data path. The module adds timestamp and suffix '_preprocessed'
# provide output_data path. The module adds timestamp and suffix '_stitched'

# Add 6 parameters in the CO panel -> input_data, preprocessed_data, output_data, informative_channel, cpus and bucket_path (in that order)

# Example
# --input_data          ../data/SMARTSPIM_FOLDER_NAME/SmartSPIM -> Points to where the channels are
# --preprocessed_data   /scratch/SMARTSPIM_FOLDER_NAME
# --output_data   /scratch/SMARTSPIM_FOLDER_NAME
# --informative_channel 0 -> idx for the channel
# --import_data.vxl1 -> resolution axis x
# --import_data.vxl2 -> resolution axis y
# --import_data.vxl3 -> resolution axis z
# --cpus 16 -> number of CPUS we want to use
# --bucket_path -> output bucket where we want to store results

python -u main.py --input_data "$1" --preprocessed_data $2 --output_data $3 --pyscripts_path /home/TeraStitcher/src/utils/pyscripts --align.sD 5 --visualization.ng_base_url https://aind-neuroglancer-sauujisjxq-uw.a.run.app --visualization.mount_service s3 --stitch_channel "$4" --import_data.vxl1 "$5" --import_data.vxl2 "$6" --import_data.vxl3 "$7" --preprocessing_steps.pystripe.workers "$8" --align.cpu_params.number_processes "$8" --merge.cpu_params.number_processes "$8" --visualization.bucket_path "$9"
