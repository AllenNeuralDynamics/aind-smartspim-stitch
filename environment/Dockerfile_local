# FROM continuumio/miniconda3:23.9.0-0
FROM condaforge/miniforge3:latest

# --------------------- #
#      METADATA         #
# --------------------- #
LABEL maintainer="Camilo Laiton <camilo.laiton@alleninstitute.org>" \
      org.opencontainers.image.title="Image Stitching" \
      org.opencontainers.image.description="Container for image stitching with BigStitcher." \
      org.opencontainers.image.version="1.2.7" \
      org.opencontainers.image.licenses="MIT"

ARG DEBIAN_FRONTEND=noninteractive

# --------------------- #
#   SYSTEM DEPENDENCIES #
# --------------------- #
RUN apt-get update && \
    apt-get upgrade -y --no-install-recommends && \
    apt-get install -y curl gcc g++ libc6 libxss-dev \
    libxxf86vm-dev libxkbfile-dev libxv-dev --fix-missing && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# --------------------- #
#     CONDA SETUP       #
# --------------------- #
RUN conda install -y -c conda-forge -c bioconda fiji openjdk && \
    conda clean -afy && \
    conda create -y -n smartspim_stitch python=3.9 --no-default-packages && \
    conda clean -afy

# Activate Conda env for all subsequent commands
SHELL ["conda", "run", "--no-capture-output", "-n", "smartspim_stitch", "/bin/bash", "-c"]

ENV PATH="/opt/conda/envs/smartspim_stitch/bin:$PATH"

RUN conda run -n smartspim_stitch pip install --no-cache-dir \
    dask==2024.1.1 \
    dask-image==2023.8.1 \
    numpy==1.26.3 \
    pathlib==1.0.1 \
    psutil==5.9.5 \
    regex==2023.10.3 \
    toml==0.10.2 \
    zarr==2.16.1 \
    natsort==8.4.0 \
    aind-data-schema==1.0.0 \
    matplotlib==3.9.2

RUN curl -fsSL -o /tmp/code-server.tar.gz https://github.com/coder/code-server/releases/download/v4.9.0/code-server-4.9.0-linux-amd64.tar.gz && \
    mkdir -p /.code-server && \
    tar -xzf /tmp/code-server.tar.gz -C /.code-server --strip-components=1 && \
    rm /tmp/code-server.tar.gz && \
    ln -s /.code-server/bin/code-server /usr/bin/code-server

COPY postInstall /
RUN /postInstall
